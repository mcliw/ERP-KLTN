user  nginx;
worker_processes  auto;

error_log  /var/log/nginx/error.log notice;
pid        /var/run/nginx.pid;

events {
    worker_connections  1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    keepalive_timeout  65;

    # Bật nén Gzip để tải trang nhanh hơn
    gzip  on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # Tăng giới hạn kích thước upload body (ví dụ upload file trong HRM)
    client_max_body_size 50M;

    # ============================================================
    # UPSTREAM DEFINITIONS (Định nghĩa các nhóm Backend bên trong Docker Network)
    # ============================================================
    
    # Trỏ đến service "gateway" (Java Public Gateway) trong docker-compose
    # Giả sử Spring Boot Gateway chạy cổng 8080 bên trong container
    upstream backend_gateway_cluster {
        server gateway:8080;
    }

    # ============================================================
    # SERVER BLOCKS (Cấu hình các Virtual Hosts)
    # ============================================================

    # --- BLOCK 1: API GATEWAY (api.erp.local) ---
    # Nhiệm vụ: Nhận request API và chuyển tiếp cho Java Public Gateway
    server {
        listen 80;
        server_name api.erp.local;

        location / {
            # Chuyển tiếp request đến upstream đã định nghĩa ở trên
            proxy_pass http://backend_gateway_cluster;

            # Các header tiêu chuẩn để backend nhận biết được client gốc
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Hỗ trợ WebSocket (nếu cần cho GraphQL subscription hoặc thông báo realtime)
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }

    # --- BLOCK 2: ERP PORTAL FRONTEND (portal.erp.local) ---
    # Nhiệm vụ: Phục vụ file tĩnh (HTML, CSS, JS) đã được build của Portal
    server {
        listen 80;
        server_name portal.erp.local;

        root /var/www/html/erp-portal; # Đường dẫn chứa file build bên trong container Nginx
        index index.html;

        location / {
            # CẤU HÌNH QUAN TRỌNG CHO SPA (React/Vue/Vite):
            # Nếu không tìm thấy file thực tế, luôn trả về index.html 
            # để client-side router của frontend xử lý việc chuyển trang.
            try_files $uri $uri/ /index.html;
        }

        # Caching cho file tĩnh (ảnh, font, css...)
        location ~* \.(?:ico|css|js|gif|jpe?g|png|woff2?|ttf)$ {
            expires 6M;
            access_log off;
            add_header Cache-Control "public";
        }
    }

    # --- BLOCK 3: ECOMMERCE STORE FRONTEND (store.erp.local) ---
    # Nhiệm vụ: Tương tự như Portal, phục vụ file tĩnh cho Store
    server {
        listen 80;
        server_name store.erp.local;

        root /var/www/html/ecommerce-store; # Đường dẫn khác cho Store
        index index.html;

        location / {
            try_files $uri $uri/ /index.html;
        }

        location ~* \.(?:ico|css|js|gif|jpe?g|png|woff2?|ttf)$ {
            expires 6M;
            access_log off;
            add_header Cache-Control "public";
        }
    }
}